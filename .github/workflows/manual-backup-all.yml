name: æ‰‹åŠ¨ä¸€é”®å¤‡ä»½æ‰€æœ‰å†å²ç‰ˆæœ¬

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  backup_all_releases:
    name: å¤‡ä»½æ‰€æœ‰ç‰ˆæœ¬
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests

      - name: æ‰§è¡Œæ‰¹é‡å¤‡ä»½
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. è·å–æ‰€æœ‰ç‰ˆæœ¬åˆ—è¡¨
          echo "æ­£åœ¨è·å–ç‰ˆæœ¬åˆ—è¡¨..."
          python check_version.py --api-history > versions.json
          
          # 2. éå†ç‰ˆæœ¬
          # ä½¿ç”¨ jq æå–ç‰ˆæœ¬å· (éœ€è¦ç¡®ä¿ jq å·²å®‰è£…ï¼ŒGithub Runner é»˜è®¤åŒ…å«)
          jq -r '.[].version' versions.json | while read tag; do
            echo "--------------------------------------------------"
            echo "å¤„ç†ç‰ˆæœ¬: $tag"
            
            # 3. æ£€æŸ¥ Release æ˜¯å¦å·²å­˜åœ¨
            if gh release view "$tag" > /dev/null 2>&1; then
              echo "âœ… Release $tag å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "ğŸ“¥ Release $tag ä¸å­˜åœ¨ï¼Œå¼€å§‹ä¸‹è½½..."
            
            # 4. ä¸‹è½½èµ„æºå¹¶ç”Ÿæˆå…ƒæ•°æ®
            # è„šæœ¬ä¼šç”Ÿæˆ release_body.md å’Œ release_info.json
            python check_version.py --download "$tag"
            
            # æ£€æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆæ–‡ä»¶
            if [ ! -f release_info.json ]; then
              echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°å…ƒæ•°æ®æ–‡ä»¶ï¼Œè·³è¿‡ $tag"
              continue
            fi
            
            # 5. è¯»å–å…ƒæ•°æ®
            TITLE=$(jq -r '.title' release_info.json)
            
            # æå–æ–‡ä»¶åˆ—è¡¨å¹¶æ„å»ºä¸Šä¼ å‚æ•°
            # æ³¨æ„ï¼šè¿™é‡Œå‡è®¾æ–‡ä»¶åä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦
            jq -r '.files[]' release_info.json > files_list.txt
            
            # 6. åˆ›å»º Release
            echo "ğŸš€ æ­£åœ¨åˆ›å»º Release: $TITLE ..."
            
            # ä½¿ç”¨ xargs æ„å»ºæ–‡ä»¶å‚æ•°åˆ—è¡¨æ˜¾å¾—æ›´å®‰å…¨ï¼Œæˆ–è€…ç›´æ¥ä½œä¸ºå‚æ•°ä¼ é€’
            # gh release create æ”¯æŒç›´æ¥è·Ÿæ–‡ä»¶è·¯å¾„
            
            FILE_ARGS=$(cat files_list.txt | tr '\n' ' ')
            
            if gh release create "$tag" --title "$TITLE" --notes-file release_body.md $FILE_ARGS; then
               echo "âœ… $tag å¤‡ä»½æˆåŠŸï¼"
            else
               echo "âŒ $tag å¤‡ä»½å¤±è´¥ï¼"
               # ä¸é€€å‡ºï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
            fi
            
            # 7. æ¸…ç†æ–‡ä»¶
            echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            if [ -f files_list.txt ]; then
                xargs rm -f < files_list.txt
                rm files_list.txt
            fi
            rm -f release_body.md release_info.json
            
            # é¿å…è¯·æ±‚è¿‡å¿«è§¦å‘é™åˆ¶ (è™½ç„¶æ˜¯å¤‡ä»½è‡ªå·±ä»“åº“ï¼Œä½†ä¸‹è½½æ˜¯å» 2dust)
            sleep 2
            
          done
